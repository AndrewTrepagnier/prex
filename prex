#!/usr/bin/env bash
set -euo pipefail

# Color helpers
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

function echo_info() { echo -e "ðŸ¤– ${YELLOW}âžœ $*${NC}"; }
function echo_success() { echo -e "ðŸ¤– ${GREEN}âœ” $*${NC}"; }
function echo_error() { echo -e "ðŸ¤– ${RED}âœ˜ $*${NC}"; }

# Friendly robot face to greet you
function prex_face() {
  cat << 'EOF'
à¼¼ ã¤ â—•_â—• à¼½ã¤
ðŸ¤– prex â€” your friendly git helper
EOF
}

# Detect current branch robustly
function current_branch() {
  local branch
  branch=$(git symbolic-ref --quiet --short HEAD 2>/dev/null || true)
  if [[ -z "$branch" ]]; then
    if [[ -f .git/rebase-apply/head-name ]]; then
      branch=$(cat .git/rebase-apply/head-name)
    elif [[ -f .git/rebase-merge/head-name ]]; then
      branch=$(cat .git/rebase-merge/head-name)
    else
      echo_error "Cannot determine current branch (detached HEAD and no rebase info)."
      exit 1
    fi
  fi
  echo "$branch"
}

function rebase_in_progress() {
  [[ -d .git/rebase-apply ]] || [[ -d .git/rebase-merge ]]
}

function ensure_git_repo() {
  git rev-parse --is-inside-work-tree &>/dev/null || {
    echo_error "Not inside a git repository."
    exit 1
  }
}

function check_clean_worktree() {
  if ! git diff --quiet || ! git diff --cached --quiet; then
    echo_error "Working directory not clean. Commit or stash your changes first."
    exit 1
  fi
}

function usage() {
  echo "ðŸ¤– prex â€” personal git helper"
  echo
  echo "Usage:"
  echo "  prex rebase        Rebase current branch onto origin"
  echo "  prex continue      Stage resolved files and continue rebase"
  echo "  prex abort         Abort rebase in progress"
  echo "  prex fix           Open first conflicted file for manual fix with instructions"
  echo "  prex push [branch] Push current or specified branch"
  echo "  prex sync          Rebase and push if clean"
  echo "  prex status        Show git status and rebase state"
  echo
  exit 1
}

function show_conflict_instructions() {
  cat << EOF
ðŸ¤– ðŸš¨ Git rebase conflict detected!

Your file contains conflict markers:

  <<<<<<< HEAD
  =======
  >>>>>>> commit_hash

Steps to resolve:

1. The conflicted file is opened in vim.
2. Look for lines starting with <<<<<<<, =======, and >>>>>>>.
3. Choose which code to keep (above or below =======), or combine them.
4. Delete all conflict markers (the <<<<<<<, =======, >>>>>>> lines).
5. Save and quit vim (:wq).
6. Run 'prex continue' to stage changes and finish the rebase.

EOF
}

cmd="${1:-}"

# === ADD THIS BLOCK ===
if [[ -z "$cmd" ]]; then
  prex_face
  echo "ðŸ¤– prex is on standby. Waiting for your command..."
  exit 0
fi
# ======================

ensure_git_repo

case "$cmd" in
  rebase)
    check_clean_worktree
    branch=$(current_branch)
    echo_info "Fetching origin..."
    git fetch origin

    echo_info "Rebasing '$branch' onto origin/$branch"
    git rebase --autostash "origin/$branch"
    echo_success "Rebase complete."
    ;;

  continue)
    if ! rebase_in_progress; then
      echo_info "No rebase in progress."
      exit 0
    fi
    echo_info "Staging resolved files..."
    git add -u

    echo_info "Continuing rebase..."
    git rebase --continue
    echo_success "Rebase continued."
    ;;

  abort)
    if ! rebase_in_progress; then
      echo_info "No rebase in progress to abort."
      exit 0
    fi
    echo_info "Aborting rebase..."
    git rebase --abort
    echo_success "Rebase aborted."
    ;;

  fix)
    if ! rebase_in_progress; then
      echo_info "No rebase in progress."
      exit 0
    fi

    conflicted_files=$(git diff --name-only --diff-filter=U)
    if [[ -z "$conflicted_files" ]]; then
      echo_info "No conflicted files detected."
      exit 0
    fi

    first_file=$(echo "$conflicted_files" | head -n 1)
    echo_info "Opening conflicted file '$first_file' for manual resolution..."
    show_conflict_instructions
    vim "$first_file"
    ;;

  push)
    branch="${2:-$(current_branch)}"
    echo_info "Pushing branch '$branch'..."
    git push origin "$branch"
    echo_success "Push complete."
    ;;

  sync)
    check_clean_worktree
    branch=$(current_branch)
    echo_info "Fetching origin..."
    git fetch origin

    echo_info "Rebasing '$branch' onto origin/$branch"
    git rebase --autostash "origin/$branch"

    echo_info "Pushing branch '$branch'..."
    git push origin "$branch"
    echo_success "Sync complete."
    ;;

  status)
    echo_info "Git status:"
    git status

    if rebase_in_progress; then
      echo_info "A rebase is in progress."
    else
      echo_info "No rebase in progress."
    fi
    ;;

  *)
    usage
    ;;
esac


